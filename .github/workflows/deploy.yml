name: Deploy via Aliyun ACR

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # 1ï¸âƒ£ Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # 2ï¸âƒ£ ç™»å½•é˜¿é‡Œäº‘ ACR
      - name: Login to Aliyun ACR
        run: |
          echo "${{ secrets.ACR_PASSWORD }}" | docker login \
            --username=${{ secrets.ACR_USERNAME }} \
            --password-stdin \
            ${{ secrets.ACR_REGISTRY }}

      # 3ï¸âƒ£ Build é•œåƒï¼ˆCI ç¯å¢ƒï¼‰
      - name: Build Docker image
        run: |
          docker build \
            --no-cache \
            -t ${{ secrets.ACR_REGISTRY }}/wdd-yyds/hub-one:latest .

      # 4ï¸âƒ£ Push é•œåƒåˆ° ACR
      - name: Push Docker image
        run: |
          docker push ${{ secrets.ACR_REGISTRY }}/wdd-yyds/hub-one:latest

      # 5ï¸âƒ£ SSH Agent
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 6ï¸âƒ£ known_hosts
      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # 7ï¸âƒ£ ECS ä¸Šæ‹‰é•œåƒå¹¶å¯åŠ¨
      - name: Deploy on ECS
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << EOF
            set -e

            echo "ğŸš€ Deploy from ACR"

            docker login \
              -u ${{ secrets.ACR_USERNAME }} \
              -p ${{ secrets.ACR_PASSWORD }} \
              ${{ secrets.ACR_REGISTRY }}

            cd ${{ secrets.SERVER_PATH }}

            docker pull ${{ secrets.ACR_REGISTRY }}/wdd-yyds/hub-one:latest

            docker compose up -d --remove-orphans

            docker image prune -f

            echo "âœ… Deploy success"
          EOF